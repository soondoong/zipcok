<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="zipcok.chat">
 
<insert id = "createRoom" parameterType="zipcok.chat.model.ChatRoomDTO">
insert into  
chatroom
values (
chatroom_idx.nextval ,
#{ croom_userid},
#{croom_coachid}, 
#{croom_req_idx},
sysdate
)

</insert>


<insert id = "insertMessage" parameterType="zipcok.chat.model.MessageDTO">
insert into  
message
values (
message_idx.nextval ,
#{msg_croom_idx},
#{msg_req_idx},
#{msg_sender}, 
#{msg_receiver},
#{msg_content},
#{msg_sendtime},
#{msg_readtime},
#{msg_userid},
#{msg_coachid}, 
#{user_mfile_upload},
#{receiver_mfile_upload},
#{user_name},
#{receiver_user_name},
1
)
</insert>


<select id ="getRecentMessage"  resultType = "zipcok.chat.model.MessageDTO">

select 
a.*
from
(select *
from message
where
msg_croom_idx = #{croom_idx}
order by msg_sendtime desc)a
where 
rownum = 1
</select>

<select id="getMessageList" resultType="zipcok.chat.model.MessageDTO">
select * from 
message
where 
msg_croom_idx =  #{croom_idx}
order by msg_sendtime asc

</select>

<update id="updateUnreadcount">
update message
set 
unreadcount = 0
where 
msg_croom_idx = #{croom_idx}
</update>


<select id ="isRoom" parameterType="zipcok.chat.model.ChatRoomDTO" resultType = "zipcok.chat.model.ChatRoomDTO">

select * from 
chatroom
WHERE croom_userid = #{croom_userid} 
and 
croom_coachid = #{croom_coachid} 
and
croom_req_idx = #{croom_req_idx} 
</select>


<select id ="findRoomInfo"  resultType = "zipcok.chat.model.ChatRoomDTO">

select * from 
chatroom
WHERE
croom_req_idx = #{croom_req_idx} 
</select>



<select id ="nomalChatRoomListSQL" parameterType="String" resultType = "zipcok.chat.model.ChatRoomListDTO">

select
modu.*,zm.mem_name,mf.mfile_upload
from 

(select * from 
chatroom left outer join 

(select 
a.*
from
(select *
from message
order by msg_sendtime desc)a
where 
rownum = 1)msg

on
croom_userid = #{id} 
and
croom_idx= msg_croom_idx(+))modu, member_file mf,zipcok_member zm

where
croom_coachid = mf.mfile_mem_id
and
mf.mfile_key = '회원프로필'
and
croom_coachid = zm.mem_id
order by croom_req_idx desc




</select>


<select id ="coachChatRoomListSQL" parameterType="String" resultType = "zipcok.chat.model.ChatRoomListDTO">

select
modu.*,zm.mem_name,mf.mfile_upload
from 

(select * from 
chatroom left outer join 

(select 
a.*
from
(select *
from message
order by msg_sendtime desc)a
where 
rownum = 1)msg

on
croom_coachid = #{id} 
and
croom_idx= msg_croom_idx(+))modu, member_file mf,zipcok_member zm

where
croom_userid = mf.mfile_mem_id
and
mf.mfile_key = '회원프로필'
and
croom_userid = zm.mem_id
order by croom_req_idx desc


</select>


<delete id="roomDelete">
delete chatroom
where 
croom_idx = #{croom_idx}
</delete>

<delete id="msgDelete">
delete message
where 
msg_croom_idx = #{croom_idx}
</delete>


  </mapper>